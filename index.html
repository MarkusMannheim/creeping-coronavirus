<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Creeping coronavirus</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <link href="./style.css" rel="stylesheet">
    <link href="./abcLogo64.png" rel="icon">
  </head>
  <body>
    <div id="container">
      <svg id="chart">
        <g id="chartGroup"></g>
      </svg>
      <div id="dayDiv"></div>
      <div id="cases"></div>
    </div>
    <div id="message">
      <p>The ACT is the last state or territory without a confirmed case.</p>
    </div>
    <script>
      d3.queue()
        .defer(d3.json, "states.topojson")
        .defer(d3.csv, "https://docs.google.com/spreadsheets/d/e/2PACX-1vQguJUu1eZrH057CfqZpQnti5ESp6-qU3pDcYXak_Y-ZT9AJFN0j8KXJsoU_JapILVykJcLL0719dFr/pub?gid=0&single=true&output=csv")
        .awaitAll(function(error, data) {
          if (error) throw error;
          landData = topojson.feature(data[0], data[0].objects.states);
          virusData = data[1];
          virusData.forEach(function(date) {
            for (column in virusData.columns.slice(1)) {
              date[virusData.columns.slice(1)[column]] = +date[virusData.columns.slice(1)[column]];
            }
            date.date = d3.timeParse("%d/%m/%Y")(date.date);
          });
          chart = d3.select("#chart");
          chartGroup = d3.select("#chartGroup");
          container = d3.select("#container");
          message = d3.select("#message");
          dayDiv = d3.select("#dayDiv");
          cases = d3.select("#cases");
          dimensions = chart.node().getBoundingClientRect();
          width = dimensions.width;
          height = dimensions.height;
          margin = { top: 0, right: width / 10, bottom: 0, left: 0 };
          projection = d3.geoIdentity()
            .fitExtent([[margin.left, margin.top], [width - margin.right, height - margin.bottom]], landData);
          path = d3.geoPath()
            .projection(projection);
          chartGroup.selectAll(".land")
            .data(landData.features)
          .enter().append("path")
            .classed("land", true)
            .attr("d", path);
          d3.xml("offshore.svg")
            .mimeType("image/svg+xml")
            .get(function(error, xml) {
              if (error) throw error;
              document.querySelector("#container")
                .appendChild(xml.documentElement);
              offshore = d3.select("#offshore")
                .datum({ properties: { code: "offshore" }})
                .lower();
              offshoreLabel = chartGroup
                .append("text")
                  .attr("id", "offshoreLabel")
                  .text("Diamond Princess")
                  .attr("x", document.querySelector("#offshore").getBoundingClientRect().left + document.querySelector("#offshore").getBoundingClientRect().width / 2)
                  .attr("y", function() { return height - margin.bottom - (width > 500 ? 20 : 15); });
              land = d3.selectAll(".land, #offshore")
                .attr("id", function(d) { return d.properties.code; })
                .each(function(d) { d.properties.infected = false; });
              germGroup = chart
                .append("g")
                  .attr("id", "germGroup");
              dateRange = d3.extent(virusData, function(d) { return d.date; });
              days = d3.timeDays(dateRange[0], dateRange[1].setDate(dateRange[1].getDate() + 1));
              day = 0;
              tally = 0;
              dayDiv.text(d3.timeFormat("%b %e")(days[day]));
              cases.html("<span>" + tally + "</span> confirmed cases");
              loopTime = 200;
              germData = [];
              germs = germGroup
                .selectAll(".germ")
                  .data(germData);
              simulation = d3.forceSimulation(germData)
                .force("charge", d3.forceManyBody().strength(5))
                .force("collision", d3.forceCollide().radius(function() { return width > 500 ? 7 : 5; }).strength(1))
                .on("tick", ticked);
              sequence();
            });
        });
      function start() {
        land.each(function(d) {
          d.properties.tally = 0;
        });
        d3.timeout(function() {
          loop();
        }, loopTime);
      }
      function loop() {
        dayDiv.text(d3.timeFormat("%b %e")(days[day]));
        let data = virusData.filter(function(d) { return d.date.valueOf() == days[day].valueOf(); });
        console.log(data);
        if (data.length == 1) {
          land.filter(function(d) { return (data[0][d.properties.code] > 0) && (d.properties.infected == false); })
            .each(function(d) { d.properties.infected = true; })
            .transition()
              .duration(loopTime)
              .style("fill", "#FFB300");
          virusData.columns.slice(1).forEach(function(d) {
            if (data[0][d] > 0) {
              let x = d == "offshore" ? document.querySelector("#offshore").getBoundingClientRect().left + document.querySelector("#offshore").getBoundingClientRect().width / 2 : path.centroid(document.querySelector("#" + d).__data__)[0];
              let y = d == "offshore" ? document.querySelector("#offshore").getBoundingClientRect().top + document.querySelector("#offshore").getBoundingClientRect().height / 2 : path.centroid(document.querySelector("#" + d).__data__)[1];
              for (i = 0; i < data[0][d]; i++) {
                tally = tally + 1;
                d3.select("span").text(tally);
                germData.push({
                  x: x,
                  y: y,
                  id: germData.length
                });
              }
            }
          });
          germs = germGroup
            .selectAll(".germ")
              .data(germData, function(d) { return d.id; });
          germs.enter()
            .append("circle")
              .classed("germ", true)
              .attr("r", 0)
              .attr("cx", function(d) { return d.x; })
              .attr("cy", function(d) { return d.y; })
              .transition()
                .duration(loopTime)
                .attr("r", function() { return width > 500 ? 7 : 5; });
          germs.exit().remove();
          simulation.nodes(germData)
            .restart();
        }
        d3.timeout(function() {
          day = day + 1;
          if (day < days.length) {
            loop()
          } else {
            reset();
          };
        }, loopTime);
      }
      function ticked() {
        germs.attr("cx", function(d) { return d.x; })
          .attr("cy", function(d) { return d.y; });
      }
      function sequence() {
        message.transition()
          .duration(1500)
            .style("opacity", 1)
          .transition()
            .delay(1500)
            .duration(1500)
            .style("opacity", 0);
        d3.timeout(function() {
          container.style("visibility", "visible")
            .transition()
              .duration(1500)
              .style("opacity", 1);
          d3.timeout(function() {
            start();
          }, 1500);
        }, 3000);
      }
      function reset() {
        d3.timeout(function() {
          land.transition()
            .duration(loopTime)
            .delay(function(d, i) { return i * 3000 / 9; })
            .style("fill", "#01CFFF")
            .each(function(d) { d.properties.infected = false; });
          d3.selectAll(".germ").transition()
            .duration(loopTime)
            .delay(function(d, i) { return i * 3000 / germData.length; })
            .attr("r", 0)
            .remove()
          d3.select("span").transition()
            .duration(3000)
            .tween("text", function(d) {
              let start = this.innerText;
              return function(t) {
                d3.select("span")
                  .text(Math.floor(start * (1 - t)));
              };
            });
          dayDiv.transition()
            .duration(3000)
            .tween("text", function(d) {
              let start = day;
              return function(t) {
                dayDiv.text(d3.timeFormat("%b %e")(days[Math.floor((1 - t) * start)]));
              };
            });
          d3.timeout(function() {
            germData = [];
            day = 0;
            tally = 0;
            loop();
          }, 4500);
        }, 3000);
      }
    </script>
  </body>
</html>
