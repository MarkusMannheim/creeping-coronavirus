<!DOCTYPE html>
<html>
  <head>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-155991615-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-155991615-1');
    </script>
    <!-- my stuff -->
    <meta charset="utf-8">
    <title>Creeping coronavirus</title>
    <meta name="description" content="The ACT was the last state or territory to confirm a case of COVID-19.">
    <meta name="keywords" content="coronavirus, australia, canberra, act, virus, corona, covid-19, covid19, disease, spread, infection">
    <meta name="author" content="Markus Mannheim">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <link href="./resources/style.css?v1" rel="stylesheet">
    <link href="./resources/abcLogo64.png" rel="icon">
    <!-- page data for scrapers -->
    <meta property="og:title" content="Creeping coronavirus">
    <meta property="og:description" content="The ACT was the last state or territory to confirm a case of COVID-19.">
    <meta property="og:image" content="https://markusmannheim.github.io/creeping-coronavirus/resources/creepingCoronavirus.jpg">
    <meta property="og:url" content="https://markusmannheim.github.io/creeping-coronavirus/">
    <meta property="og:type" content="website">
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:site" content="@MarkusMannheim">
    <meta property="twitter:creator" content="@MarkusMannheim">
  </head>
  <body>
    <!-- initial page layout -->
    <div id="container">
      <svg id="chart">
        <g id="landGroup"></g>
        <g id="germGroup"></g>
      </svg>
      <div id="dayDiv"></div>
      <div id="cases"></div>
    </div>
    <script>
      // load in virus tallies and geographic shapes
      d3.queue()
        .defer(d3.json, "./resources/states.topojson")
        .defer(d3.csv, "https://docs.google.com/spreadsheets/d/e/2PACX-1vQguJUu1eZrH057CfqZpQnti5ESp6-qU3pDcYXak_Y-ZT9AJFN0j8KXJsoU_JapILVykJcLL0719dFr/pub?gid=0&single=true&output=csv")
        .awaitAll(function(error, data) {
          if (error) throw error;
          // parse topojson
          landData = topojson.feature(data[0], data[0].objects.states);
          // format virus tallies
          virusData = data[1];
          virusData.forEach(function(date) {
            for (column in virusData.columns.slice(1)) {
              date[virusData.columns.slice(1)[column]] = +date[virusData.columns.slice(1)[column]]; // string to float
            }
            date.date = d3.timeParse("%d/%m/%Y")(date.date); // string to datetime object
          });
          // establish element variables
          chart = d3.select("#chart");
          landGroup = d3.select("#landGroup");
          germGroup = d3.select("#germGroup");
          container = d3.select("#container");
          dayDiv = d3.select("#dayDiv");
          cases = d3.select("#cases");
          dimensions = chart.node().getBoundingClientRect();
          width = dimensions.width;
          height = dimensions.height;
          margin = { top: 0, right: width * .2, bottom: 8, left: 0 };
          // map projection functions
          projection = d3.geoIdentity()
            .fitExtent([[margin.left, margin.top], [width - margin.right, height - margin.bottom]], landData);
          path = d3.geoPath()
            .projection(projection);
          // draw states & territories
          land = landGroup
            .selectAll(".land")
              .data(landData.features)
            .enter().append("path")
              .classed("land", true)
              .attr("id", function(d) { return d.properties.code; })
              .attr("d", path);
          // set loop parameters
          dateRange = d3.extent(virusData, function(d) { return d.date; });
          days = d3.timeDays(dateRange[0], dateRange[1].setDate(dateRange[1].getDate() + 1));
          // javascript's .setDate() method tracks back and changes the original datum! Resetting it here
          virusData[virusData.length - 1].date = days[days.length - 1];
          // establish initial parameters
          day = 0;
          tally = 0;
          radius = width > 500 ? 5 : 3;
          loopTime = 200;
          day = 0;
          tally = 0;
          germData = [];
          // initial date & case display
          dayDiv.text(d3.timeFormat("%b %e, %Y")(days[day]));
          cases.html("<span>" + tally + "</span> confirmed cases");
          // establish germ nodes (empty)
          germs = germGroup
            .selectAll(".germ")
              .data(germData);
          // physics engine for clustering germs
          simulation = d3.forceSimulation(germData)
            .force("charge", d3.forceManyBody().strength(5))
            .force("collision", d3.forceCollide().radius(radius).strength(1))
            .on("tick", ticked);
          // initial fade in then start
          container.transition()
            .duration(1500)
            .style("opacity", 1);
          d3.timeout(function() {
            loop();
          }, 3000);
        });
      function loop() {
        land.each(function(d) {
          d.properties.infected = false; d.properties.tally = 0;
        });
        dayDiv.text(d3.timeFormat("%b %e, %Y")(days[day]));
        let data = virusData.filter(function(d) { return d.date.valueOf() == days[day].valueOf(); });
        if (data.length == 1) {
          land.filter(function(d) { return (data[0][d.properties.code] > 0) && (d.properties.infected == false); })
            .each(function(d) { d.properties.infected = true; })
            .transition()
              .duration(loopTime)
              .style("fill", "#FFB300");
          virusData.columns.slice(1).forEach(function(d) {
            if (data[0][d] > 0) {
              let x = path.centroid(document.querySelector("#" + d).__data__)[0];
              let y = path.centroid(document.querySelector("#" + d).__data__)[1];
              for (i = 0; i < data[0][d]; i++) {
                tally = tally + 1;
                d3.select("span").text(tally);
                germData.push({
                  x: x,
                  y: y,
                  id: germData.length
                });
              }
            }
          });
          germs = germGroup
            .selectAll(".germ")
              .data(germData, function(d) { return d.id; });
          germs.enter()
            .append("circle")
              .classed("germ", true)
              .attr("r", 0)
              .attr("cx", function(d) { return d.x; })
              .attr("cy", function(d) { return d.y; })
              .transition()
                .duration(loopTime)
                .attr("r", radius);
          germs.exit().remove();
          simulation.nodes(germData)
            .restart();
        }
        d3.timeout(function() {
          day = day + 1;
          if (day < days.length) {
            loop();
          } else {
            reset();
          };
        }, loopTime);
      }
      function ticked() {
        germs.attr("cx", function(d) { return d.x; })
          .attr("cy", function(d) { return d.y; });
      }
      function reset() {
        d3.timeout(function() {
          land.transition()
            .duration(loopTime)
            .delay(function(d, i) { return i * 3000 / 9; })
            .style("fill", "#01CFFF")
            .each(function(d) { d.properties.infected = false; });
          d3.selectAll(".germ").transition()
            .duration(loopTime)
            .delay(function(d, i) { return i * 3000 / germData.length; })
            .attr("r", 0)
            .remove()
          d3.select("span").transition()
            .duration(3000)
            .tween("text", function(d) {
              let start = this.innerText;
              return function(t) {
                d3.select("span")
                  .text(Math.floor(start * (1 - t)));
              };
            });
          dayDiv.transition()
            .duration(3000)
            .tween("text", function(d) {
              let start = day;
              return function(t) {
                dayDiv.text(d3.timeFormat("%b %e, %Y")(days[Math.floor((1 - t) * start)]));
              };
            });
          d3.timeout(function() {
            germData = [];
            day = 0;
            tally = 0;
            loop();
          }, 4500);
        }, 3000);
      }
    </script>
  </body>
</html>
